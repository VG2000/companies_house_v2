{% extends 'company_data/base.html' %}

{% block title %}Filter Companies{% endblock %}

{% block content %}

<!-- Filtered Results -->
<h2>Filtered Company Count</h2>
<p>Total companies matching the filter criteria: <strong>{{ filtered_count }}</strong></p>

<!-- Filter Form -->
<form method="get" class="mb-4">
    <!-- Accounts Next Due Date -->
    <div class="mb-3">
        {{ form.accounts_next_due_date.label_tag }}
        {{ form.accounts_next_due_date }}
    </div>

    <!-- Accounts Account Category -->
    <div class="mb-3">
        {{ form.accounts_account_category.label_tag }}
        {{ form.accounts_account_category }}
    </div>

    <!-- SIC Code -->
    <div class="mb-3">
        {{ form.sic_code_1.label_tag }}
        {{ form.sic_code_1 }}
    </div>

    <!-- Link to SIC Codes Page -->
    <p>
        <a href="{% url 'available_sic_codes' %}" class="btn btn-secondary btn-sm">Available SIC Codes</a>
    </p>

    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary">Filter</button>
    <!-- Button to update companies -->
    <button id="update-companies" class="btn btn-warning">Update Current Full Accounts</button>
    <!-- Button to reset companies_full_accounts to False -->
    <button id="reset-companies" class="btn btn-danger" type="button">Reset Current Full Accounts</button>
    <!-- Button to reset the form -->
    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
</form>

{% if page_obj %}
    <!-- Filtered Companies Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Company Name</th>
                <th>Company Number</th>
                <th>Address</th>
                <th>Category</th>
                <th>Status</th>
                <th>Country of Origin</th>
                <th>Next Due Date</th>
            </tr>
        </thead>
        <tbody>
            {% for company in page_obj %}
            <tr class="company-row" data-id="{{ company.id }}"></tr>
                <td>{{ company.company_name }}</td>
                <td>{{ company.company_number }}</td>
                <td>
                    {{ company.reg_address_line1 }}, {{ company.reg_address_line2 }},
                    {{ company.reg_address_post_town }}, {{ company.reg_address_postcode }}
                </td>
                <td>{{ company.accounts_account_category }}</td>
                <td>{{ company.company_status }}</td>
                <td>{{ company.country_of_origin }}</td>
                <td>{{ company.accounts_next_due_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if filtered_count > 0 %}
    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1&{{ request.GET.urlencode }}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
        {% endif %}

            {% else %}
                <p>No filters applied yet. Use the form above to filter the companies.</p>
            {% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Handle updating companies based on filters
    document.getElementById('update-companies').addEventListener('click', function () {
        // Collect filter parameters from the form
        const formData = new FormData(document.querySelector('form'));
        const payload = {};

        // Convert form data to a JSON object
        formData.forEach((value, key) => {
            if (value) {
                if (payload[key]) {
                    // Handle multiple values for the same key
                    if (!Array.isArray(payload[key])) {
                        payload[key] = [payload[key]];
                    }
                    payload[key].push(value);
                } else {
                    payload[key] = value;
                }
            }
        });

        console.log("Payload being sent to backend:", payload); // Log payload to debug

        fetch("{% url 'update_current_full_accounts' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload), // Send the filter parameters as JSON
        })
            .then(response => response.json())
            .then(data => {
                console.log("Response from backend:", data); // Log backend response
                if (data.status === 'success') {
                    console.log(data.message);
                    alert(data.message);
                } else {
                    console.error("Error: ", data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    });

    // Handle resetting all current_full_accounts to False
    document.getElementById('reset-companies').addEventListener('click', function () {
        if (!confirm("Are you sure you want to reset all current_full_accounts to False? This action cannot be undone.")) {
            return;
        }

        fetch("{% url 'reset_current_full_accounts' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log("Response from backend:", data); // Log backend response
                if (data.status === 'success') {
                    console.log(data.message);
                    alert(data.message);
                } else {
                    console.error("Error: ", data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    });
    // Handle form reset
    function resetForm() {
        // Reset the form to its default state
        document.querySelector('form').reset();
        // Optionally clear the query parameters in the URL
        const url = new URL(window.location.href);
        url.search = ''; // Clear all query parameters
        window.history.replaceState({}, document.title, url);
    }
</script>





{% endblock %}