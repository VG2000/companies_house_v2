{% extends "company_data/base.html" %} 

{% block content %}
<div class="container mt-4">
    <h2>Statement Admin</h2>

    <!-- Buttons for Statement Processing -->
    <button id="trigger-last-full-statement-btn" class="btn btn-primary">Download Last Full Statements</button>
    <button id="trigger-process-statements-btn" class="btn btn-secondary">Process Downloaded Statements To DB</button>

    <!-- Newly Added Buttons -->
    <button id="update-companies-btn" class="btn btn-warning">Update Current Full Accounts</button> 
    <button id="reset-companies-btn" class="btn btn-danger" type="button">Reset Current Full Accounts</button>

    <!-- Status message -->
    <div id="status-message" class="alert d-none mt-3"></div>
</div>

<script>
    function triggerView(url, statusMessageElement, buttonElement) {
        // Show a loading message
        statusMessageElement.className = "alert alert-info";
        statusMessageElement.textContent = "Processing request...";

        // Disable the button during processing
        buttonElement.disabled = true;

        // Send a POST request to the view
        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                // Update the status message based on the response
                if (data.status === "error") {
                    statusMessageElement.className = "alert alert-danger";
                    statusMessageElement.textContent = data.message;
                } else {
                    statusMessageElement.className = "alert alert-success";
                    statusMessageElement.textContent = data.message;
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                statusMessageElement.className = "alert alert-danger";
                statusMessageElement.textContent = "An error occurred while processing the request.";
            })
            .finally(() => {
                // Ensure the status message is visible and re-enable the button
                statusMessageElement.classList.remove("d-none");
                buttonElement.disabled = false;
            });
    }

    // Attach event listeners to all buttons
    document.getElementById("trigger-last-full-statement-btn").addEventListener("click", function () {
        triggerView("{% url 'get_last_full_statement_file_type' %}", document.getElementById("status-message"), this);
    });

    document.getElementById("trigger-process-statements-btn").addEventListener("click", function () {
        triggerView("{% url 'process_all_statements' %}", document.getElementById("status-message"), this);
    });

    // New buttons for updating and resetting full accounts
    document.getElementById("update-companies-btn").addEventListener("click", function () {
        triggerView("{% url 'update_current_full_accounts' %}", document.getElementById("status-message"), this);
    });

    document.getElementById("reset-companies-btn").addEventListener("click", function () {
        if (confirm("Are you sure you want to reset all current full accounts? This action cannot be undone.")) {
            triggerView("{% url 'reset_current_full_accounts' %}", document.getElementById("status-message"), this);
        }
    });
</script>
{% endblock %}
